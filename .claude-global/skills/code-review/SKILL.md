---
name: code-review
description: コードレビュー実行。「コードレビュー」「レビューして」と依頼された時に使用。4観点（Security、Correctness、Design、Testing）で評価。
---

# Code Review

コードレビューを実行し、高信号フィードバックを提供するスキル。

## 前提条件

1. レビュー対象ファイルが存在
2. CLAUDE.md が読み込み可能

## 実行手順

### Step 1: 前処理チェック（Haiku）

Task tool で Haiku エージェントを起動し、適格性をチェック:

- 大規模変更（50ファイル超 or 1000行超）→ 分割レビューを提案
- レビュー不要（設定ファイルのみ、自動生成コード等）→ 中止

**中止条件に該当した場合、理由を説明して終了**

### Step 2: 並列レビュー（4観点）

**必須**: 4つのTask toolを**単一メッセージで並列実行**

自分で直接レビューしない。必ずサブエージェントに委譲する。

| 観点 | モデル | チェックリスト |
|------|--------|----------------|
| security | Opus | `checklists/security.md` |
| correctness | Opus | `checklists/correctness.md` |
| design | Sonnet | `checklists/design.md` |
| testing | Sonnet | `checklists/testing.md` |

各promptの構造:
```
あなたは${観点}専門のコードレビュアーです。

## ロール
${guides/agents.mdから該当ロールをコピー}

## チェックリスト
${checklists/${観点}.mdの内容}

## 高信号フィルタ
フラグすべき:
- コンパイル/パースエラー、型エラー
- 明確なロジックエラー
- セキュリティ脆弱性（SQLインジェクション、XSS等）
- CLAUDE.md違反（引用可能なもの）

フラグしない:
- コードスタイル
- 潜在的問題（入力依存）
- Linterがcatchする問題
- 既存コードの問題（新規導入ではない）

## レビュー対象
${対象コード}

## 出力形式
| ファイル:行 | 問題 | 修正案 |
```

### Step 3: 検証

Step 2で検出されたissueを別サブエージェントで再検証:

- security/correctness の issue → Opus
- design/testing の issue → Sonnet

各issueに対して:
- 位置検証: 行番号に該当コードが存在するか
- 妥当性検証: 本当に問題か、高信号基準を満たすか

**検証されないissueは破棄**

### Step 4: フィルタリング

- 検証されなかったissueを削除
- 同一箇所への複数指摘を統合
- 重複を排除

### Step 5: 出力

`templates/output.md` の形式に従い、**カレントディレクトリに `review.md` として書き出す**。

既存の `review.md` がある場合は上書きする。

## 出力形式

```markdown
# コードレビュー結果: [対象]

## Issues

### 1. `file.ts:42` - [問題の簡潔な説明]
**観点**: security
**問題**: [具体的な問題点]
**根拠**: [コード引用]
**修正案**: [推奨する修正方法]

### 2. ...

## 総評
指摘: X件
観点別: security X, correctness X, design X, testing X
```

## 高信号フィルタ基準

### フラグすべき

- コンパイル/パースエラー、型エラー、missing imports
- 明確なロジックエラー（確実に間違った結果を生む）
- セキュリティ脆弱性（SQLインジェクション、XSS、認証・認可の欠陥）
- CLAUDE.md違反（具体的なルールを引用可能）

### フラグしない

- コードスタイルの懸念
- 入力依存の潜在的問題
- 主観的な改善提案
- Linterがcatchする問題
- 既存の問題（新規導入ではない）
- ベテランエンジニアがフラグしない細部

## 成功基準

1. 高信号issueのみを報告
2. 根拠・修正案を含む
3. 検証済み（偽陽性を排除）

## よくあるパターン

→ `templates/patterns.md`

| パターン | 問題 | 修正 |
|---------|------|------|
| N+1クエリ | ループ内でクエリ | Eager Loading |
| 競合状態 | 共有状態へのアクセス | 排他制御 |
| 依存注入 | 依存を直接生成 | コンストラクタ注入 |
| テスト | Stubの呼び出し検証 | 最終結果のみ検証 |
