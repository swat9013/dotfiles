# CLAUDE.md 設計ガイド

## 概要

CLAUDE.mdはプロジェクト固有のコンテキストをClaudeに提供するファイル。プロジェクトルートに配置され、常に参照される。

## ファイル制約

| 項目 | 値 |
|------|-----|
| 推奨サイズ | 150行以下（公式上限は500行） |
| 配置場所 | プロジェクトルート / `.claude/CLAUDE.md` 等（後述） |
| 形式 | Markdown（frontmatter不要） |

> **注**: 公式ドキュメントの上限は500行だが、Claude が確実に遵守できる実用上限は150〜200行。コンテキスト節約のためにも150行以下を推奨。

## 配置場所と読み込み優先順位

複数ロケーションをサポートし、優先度順に全て読み込まれる（加算的）。

| 優先度 | パス | 用途 | 共有 |
|--------|------|------|------|
| 1（最高）| `/Library/Application Support/ClaudeCode/CLAUDE.md`（macOS）| エンタープライズポリシー | 組織全体 |
| 2 | `~/.claude/CLAUDE.md` | 個人の全プロジェクト共通設定 | 自分のみ |
| 3 | `./CLAUDE.md` または `./.claude/CLAUDE.md` | プロジェクト設定（git管理） | チーム |
| 4 | `./.claude/rules/*.md` | パス条件付きルール | チーム |
| 5（最低）| `./CLAUDE.local.md` | 個人プロジェクト設定（`.gitignore`自動追加） | 自分のみ |

### サブディレクトリへの配置

- `cwd` からルートまで階層を上方向に探索し、全 `CLAUDE.md` を読み込む
- サブディレクトリの `CLAUDE.md` はそのディレクトリのファイル操作時にオンデマンド読み込み
- モノレポ対応: 言語・ドメインごとに `src/CLAUDE.md`, `api/CLAUDE.md` 等で分割可能

## インポート構文（`@` 参照）

```markdown
## プロジェクト概要
詳細は @README.md を参照。npm コマンドは @package.json を確認。

## Git ワークフロー
@docs/git-instructions.md
```

- **相対パスと絶対パス**両対応。ホームディレクトリ（`@~/.claude/...`）参照も可能
- **再帰インポート**: 最大深さ5ホップ
- **コードスパン内は評価されない**: `` `@file` `` はインポートされない
- **初回承認ダイアログ**: 外部ファイルのインポートは初回のみ確認

## 設計原則

1. **プロジェクト固有**: 汎用知識より具体的なルール
2. **簡潔**: 150行以下推奨
3. **構造化**: 表・箇条書きの活用

## CLAUDE.md vs rules/ vs skills/

比較表と使い分け判断フローは [context-architecture.md](./context-architecture.md) を参照。

## CLAUDE.md vs README.md

| 観点 | CLAUDE.md | README.md |
|------|-----------|-----------
| 対象読者 | Claude | 人間（開発者） |
| 目的 | コンテキスト提供 | プロジェクト紹介 |
| 内容 | 開発に必要な制約 | セットアップ手順 |
| 詳細度 | 簡潔・要点のみ | 詳細な説明 |

README.mdとCLAUDE.mdは補完関係。重複を避け、それぞれの役割に集中する。

## 推奨構造

```markdown
# CLAUDE.md

## リポジトリの概要
このプロジェクトが何か（1-2文）

## コマンド
```bash
# よく使うコマンド
npm run dev
npm test
```

## アーキテクチャ
ディレクトリ構造と役割

## 命名規則
プロジェクト固有の命名ルール

## 重要な制約
守るべき原則・制限
```

## 良いCLAUDE.mdの特徴

### 含めるべき内容

- **プロジェクト構造**: ディレクトリの役割
- **重要なコマンド**: ビルド、テスト、デプロイ
- **固有の命名規則**: ファイル名、変数名のパターン
- **アーキテクチャ上の制約**: レイヤー構造、依存関係
- **開発ワークフロー**: ブランチ戦略、コミット規約

### 含めるべきでない内容

- 一般的なプログラミング原則のみ（Claudeは既知）
- README.mdとの重複
- 詳細すぎる実装ガイド（→ rules/ または docs/）
- 長いコード例（→ 別ファイル参照）

## 書き方ガイド

### 簡潔に

```markdown
## 悪い例
このプロジェクトは、ユーザー管理機能を提供するWebアプリケーションです。
フロントエンドはReactで構築され、バックエンドはNode.jsで...（続く）

## 良い例
ユーザー管理WebアプリReact + Node.js構成。
```

### 表・箇条書きを活用

```markdown
## 悪い例
srcディレクトリにはコンポーネントが入っていて、apiディレクトリには
APIクライアントが入っていて、utilsには...

## 良い例
| ディレクトリ | 役割 |
|------------|------|
| src/ | Reactコンポーネント |
| api/ | APIクライアント |
| utils/ | 共通ユーティリティ |
```

### コマンドは実行可能な形で

```markdown
## 悪い例
テストを実行するにはnpm testコマンドを使います。

## 良い例
```bash
npm test              # 全テスト実行
npm test -- --watch   # 監視モード
```
```

## アンチパターン

| パターン | 問題点 | 対策 |
|---------|--------|------|
| 150行超 | 情報過多、読まれない | 150行以下に圧縮 |
| 一般原則のみ | プロジェクト固有情報なし | 固有の情報を追加 |
| README重複 | メンテナンス二重化 | 補完関係にする |
| 詳細すぎる | CLAUDE.mdの役割逸脱 | rules/やdocs/に分離 |
| `/init` 生成そのまま使用 | 冗長な説明が含まれる | 生成後に人手で精査・削除 |
| 長いセッションで指示忘れ | コンテキスト圧縮後に機能低下 | `/clear` を活用、重要指示を明示的に記載 |

## 2025年の新機能

### `#` キーによるクイックメモリ追加

セッション中に `#` キーで即座に CLAUDE.md を編集できる。作業中に気づいたルールをその場で記録可能。

### `/memory` コマンド

```bash
/memory    # システムエディタで全メモリファイルを一括編集
```

複数のメモリファイル（CLAUDE.md、CLAUDE.local.md、Auto Memory）を統一インターフェースで管理。

### Auto Memory（自動記録）

Claude Code が自動的にプロジェクトの学習内容を記録する機能。

| 項目 | 内容 |
|------|------|
| ロケーション | `~/.claude/projects/<project>/memory/MEMORY.md` |
| 記録内容 | デバッグ知見、アーキテクチャノート、プロジェクトパターン |
| 管理 | `/memory` コマンドで閲覧・編集 |
| 無効化 | `CLAUDE_CODE_DISABLE_AUTO_MEMORY` 環境変数 |

### ユーザーレベルルール

`~/.claude/rules/` に個人的なルールを配置可能。プロジェクトルールより先に読み込まれる。

```
~/.claude/
├── CLAUDE.md        # 全プロジェクト共通設定
├── rules/           # 個人ルール（パスマッチでオンデマンド）
│   ├── git.md
│   └── code-style.md
└── skills/          # 個人スキル
```
