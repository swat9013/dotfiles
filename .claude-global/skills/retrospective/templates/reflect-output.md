# 振り返り分析結果

## セッション情報

- **ファイル**: `{session_file_path}`
- **メッセージ数**: {user_messages}件（ユーザー）/ {assistant_messages}件（アシスタント）
- **分析日時**: {analysis_timestamp}

---

## 抽出結果サマリー

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | {category} | {summary} | {destination} | {confidence} |

### 凡例

**カテゴリ**（14種）:
アーキテクチャ / 技術選択 / コーディング規約 / 落とし穴 / コマンド / 依存関係 / データ構造 / 環境・設定 / 用語 / 境界条件 / パフォーマンス / 権限設定 / ワークフロー摩擦 / 設定改善

**保存先**（5択）:
- `CLAUDE.md` — プロジェクト全体に常時必要な知識・制約
- `rules/` — 特定パス・ファイル種別に紐づくルール
- `skills/` — 3ステップ以上の再利用可能な手順・ワークフロー
- `settings.local.json` — allow/ask/deny の最適化（ツール許可設定）
- `破棄` — 一時的・汎用的・このセッション限りの情報

> 詳細な分類基準は `classification-criteria.md` を参照

**信頼度**:
- `高` — セッション内で明確に確認・実証された事実
- `中` — 文脈から推測できるが、追確認を推奨
- `低` — 断片的な情報からの推測

---

## カテゴリ別 記入例

### アーキテクチャ

プロジェクトの構造的な設計判断、コンポーネント間の関係、レイヤー分離の方針。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | アーキテクチャ | skills/はコンテキスト共有、agents/は分離実行。サブエージェントはskill内でTask toolを呼び出す | CLAUDE.md | 高 |
| 2 | アーキテクチャ | retrospective/templates/はサブエージェント出力フォーマット専用ディレクトリ | CLAUDE.md | 高 |

### 技術選択

採用した技術・ライブラリ・ツールの選択理由と代替案の却下理由。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 技術選択 | JSONLパースにjqを使用。Pythonより依存が少なく、シェルスクリプトとの親和性が高い | CLAUDE.md | 高 |
| 2 | 技術選択 | sheldonをzshプラグイン管理に採用。zinit比でシンプルなTOML設定が決め手 | CLAUDE.md | 中 |

### コーディング規約

このプロジェクト固有のコーディングスタイル、命名規則、記述パターン。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | コーディング規約 | SKILL.mdのfrontmatterはkebab-case、64文字以内 | rules/claude-global-skills.md | 高 |
| 2 | コーディング規約 | シェルスクリプトのオプション解析はcaseステートメントで統一（getoptsは使わない） | rules/ | 中 |

### 落とし穴

実際に踏んだバグ・誤解・失敗パターン。同じミスを繰り返さないための記録。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 落とし穴 | rulesのpathsにYAML配列（ハイフン複数行）は適用されない。カンマ区切りワンライナーで記述 | CLAUDE.md | 高 |
| 2 | 落とし穴 | zshサブシェル内（$()）でPATH解決が失敗することがある。フルパスを使う | CLAUDE.md | 高 |

### コマンド

実際に動作確認済みのコマンド、オプション、実行例。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | コマンド | `find "$SESSION_DIR" -maxdepth 1 -name "*.jsonl" -not -name "agent-*" -newermt "$DATE"` でagentセッションを除外 | skills/ | 高 |
| 2 | コマンド | `lsof -a -d cwd -p $pid` で特定プロセスの作業ディレクトリを取得（-aフラグでAND条件） | CLAUDE.md | 高 |

### 依存関係

ライブラリ・ツール・サービス間の依存関係、バージョン制約、互換性情報。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 依存関係 | extract-messages.shはjq必須。Homebrewで事前インストールが必要 | CLAUDE.md | 高 |
| 2 | 依存関係 | yaziのfazif-yaziプラグインはfd・rg・fzfに依存。全て/opt/homebrew/bin/配下を期待 | CLAUDE.md | 中 |

### データ構造

主要なデータフォーマット、スキーマ、変換ルール。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | データ構造 | セッションJSONLのtool_resultは.messageラッパーなしで.contentに直接値が入る | skills/ | 高 |
| 2 | データ構造 | .message.contentはstring型またはarray型（text/tool_use要素の配列）の2パターン | skills/ | 高 |

### 環境・設定

OS・シェル・ツール固有の設定、環境変数、パス解決の挙動。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 環境・設定 | macOSのdateコマンドは`-v-Nd`形式、Linuxは`-d "-N days"`形式。両対応が必要 | CLAUDE.md | 高 |
| 2 | 環境・設定 | Claude Codeのセッションファイルは`~/.claude/projects/{encoded_path}/*.jsonl`に保存 | skills/ | 高 |

### 用語

プロジェクト固有の用語定義、概念の意味、チーム内での共通理解。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 用語 | 「retrospective」= セッション振り返りからドメイン知識を抽出・保存するスキル | CLAUDE.md | 高 |
| 2 | 用語 | 「4層保存先」= CLAUDE.md / rules/ / skills/ / settings.local.json の4保存先分類体系 | CLAUDE.md | 高 |

### 境界条件

エッジケース、入力値の限界、エラーが起きる条件。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 境界条件 | セッションディレクトリが存在しない場合、find-sessions.shは空出力で正常終了（exit 0） | skills/ | 高 |
| 2 | 境界条件 | JSONL内のtool_result.contentがnullの場合、jqフィルターで空文字として処理し出力をスキップ | skills/ | 高 |

### パフォーマンス

処理速度、メモリ使用量、スケーラビリティに関する発見。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | パフォーマンス | Task toolで起動したサブエージェントは親セッション終了後も残存しメモリ消費。`cck --sub`で定期クリーンアップ | CLAUDE.md | 高 |
| 2 | パフォーマンス | SKILL.mdが500行・15,000文字を超えるとコンテキスト消費が増大。references/に分離 | CLAUDE.md | 高 |

### 権限設定

Claude Codeのtools allow/ask/deny設定、セキュリティ境界、実行許可の最適化。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 権限設定 | `Bash(find:*)` を allow に設定することで毎回確認が不要になる | settings.local.json | 高 |
| 2 | 権限設定 | `Bash(rmtrash:*)` はaskのまま維持。削除操作は確認を残す | settings.local.json | 中 |

### ワークフロー摩擦

繰り返し発生する手作業、確認待ち、非効率なステップ。自動化・改善の候補。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | ワークフロー摩擦 | セッション分析のたびにJSONLパスを手動で調べる必要がある。find-sessions.shで自動化済み | 破棄 | 高 |
| 2 | ワークフロー摩擦 | `Bash(git log:*)` の確認が毎回発生する。allow追加を検討 | settings.local.json | 中 |

### 設定改善

CLAUDE.md・rules/・settings.json等の現在の設定に対する改善提案。

| # | カテゴリ | 内容 | 保存先 | 信頼度 |
|---|----------|------|--------|--------|
| 1 | 設定改善 | domain-contextスキルのトリガーが曖昧で誤マッチが発生している。retrospectiveへ統合を検討 | CLAUDE.md | 中 |
| 2 | 設定改善 | rules/claude-global-skills.mdのスキル一覧が古い。retrospectiveを追加する | rules/ | 高 |

---

## 詳細（項目ごと）

<!-- 各抽出項目を以下のフォーマットで記載 -->

### {連番}. {タイトル}

**カテゴリ**: {category}
**信頼度**: 高 / 中 / 低
**推奨保存先**: {destination}
**推奨セクション**: {section_in_file}

**内容**:
{detailed_description}

**根拠**（セッションからの引用）:
```
{quote_from_session}
```

---

## 除外項目

抽出候補だったが除外した項目とその理由。

| 内容の概要 | 除外理由 |
|-----------|---------|
| {excluded_content} | 汎用的すぎる / 一時的 / セッション固有 / 既存ドキュメントに記載済み |

---

## 次のステップ

### 既存ドキュメントとの整合性チェック

- [ ] 既存 CLAUDE.md との重複はないか
- [ ] 既存 rules/ の内容と矛盾しないか
- [ ] 既存 skills/ に統合すべきものはないか
- [ ] settings.local.json の現在の設定と競合しないか

### 保存実行

確認後、保存先ごとに追記・更新を実行してください:

- `CLAUDE.md` の該当セクションに追記
- `rules/{filename}.md` の該当セクションに追記
- `skills/{skill-name}/` の該当ファイルに追記
- `settings.local.json` の `permissions.allow` / `ask` / `deny` を更新
