# Refactor Skill 改善計画書

## 問題の特定

### 現状の問題
refactor-plan.md作成後、Claudeが自動的にPhase 3（段階的実行）に進んでしまい、ユーザーの承認なしに実装を開始するケースがある。

### 根本原因
SKILL.mdのワークフロー定義において、Phase 2（計画分解）からPhase 3（段階的実行）への移行条件が明記されていない。

- Phase 2: 131行目 `refactor-plan.md 生成`
- Phase 3: 133行目 `段階的実行`

両フェーズが連続して記載されており、間に明示的な「停止」「ユーザー承認待ち」のステップが存在しない。

## 他スキルとの比較分析

### architect スキル
- Phase 3で plan.md 作成後、フィードバックループあり（156行目）
- しかし明示的な「停止」は未記載
- 実装フェーズへの自動遷移なし（architectは設計のみで実装しないため）

### breakdown スキル
- implementation.md 生成後、出力形式で「次のステップ: /implement で自動実行 または手動で順次実装」と明示（85-87行目）
- 自動的にimplementスキルを呼び出さない設計

### refactor スキルの特殊性
- **設計と実装の両方を含む**スキルである点が他と異なる
- Phase 2（計画）とPhase 3（実装）の境界が曖昧
- 実装フェーズを含むため、明示的な停止が必須

## 改善提案

### 1. Phase 2 完了時の停止ステップ追加

Phase 2の最後（128-130行目）に以下を追加:

```markdown
### Phase 2 完了

refactor-plan.md生成後、以下を出力してユーザー承認を待つ:

\`\`\`markdown
## リファクタリング計画作成完了

**保存先**: refactor-plan.md
**検出スメル**: X個
**実施ステップ数**: X
**推定所要時間**: 合計 Xh

**計画内容**:
- [スメル1]: [対処法] - [対象ファイル]
- [スメル2]: [対処法] - [対象ファイル]

**次のステップ**:
計画を確認し、実行する場合は以下を指示してください:
- `refactor-plan.mdを実行して`
- または `/refactor --execute`

中止する場合: `中止`
修正が必要な場合: 修正内容を指示
\`\`\`

**重要**: この時点で処理を停止し、ユーザーからの指示を待つ。**Phase 3に自動遷移しない**。
```

### 2. Phase 3 開始条件の明記

Phase 3の冒頭（133行目）を以下に変更:

```markdown
### Phase 3: 段階的実行

**開始条件**: ユーザーから以下のいずれかの指示があった場合のみ実行
- `refactor-plan.mdを実行して`
- `/refactor --execute`
- `実行して`
- 明示的な実行指示

**注意**: Phase 2完了時に自動的にこのフェーズに進まない。
```

### 3. 安全性ガードレール更新

191-199行目の安全性ガードレールに以下を追加:

| ガードレール | 実装 |
|------------|-----|
| **ユーザー承認必須** | **Phase 2完了時に停止、Phase 3は明示的指示でのみ開始** |
| テスト必須 | Phase 1でテスト有無判定、なければCharacterization Test提案 |
| 1変更1コミット | Phase 3で各ステップ後にコミット |
| 即座のロールバック | テスト/Lint失敗時に`git checkout .`実行 |
| 影響範囲制限 | HIGH判定時にステップ強制分割 |

### 4. 実行手順の明確化

27行目「実行手順」の直後に以下を追加:

```markdown
**重要**: このスキルは計画（Phase 1-2）と実行（Phase 3）が分離されている。
- Phase 2完了時に必ず停止し、ユーザー承認を待つ
- Phase 3はユーザーからの明示的指示があった場合のみ実行
```

## 実装方針

### 変更対象ファイル
- `.claude-global/skills/refactor/SKILL.md`

### 変更箇所
1. 27行目付近: 実行手順の説明強化
2. 128-130行目: Phase 2完了ステップ追加
3. 133-136行目: Phase 3開始条件の明記
4. 191-199行目: 安全性ガードレール更新

### 変更影響
- 既存のrefactor-plan.mdフォーマットは変更なし
- templates/, references/, guides/ は変更不要
- ユーザー体験: 計画確認後に明示的な実行指示が必要になる（意図通り）

## 成功基準

1. ✅ Phase 2完了時、refactor-plan.md生成後に必ず停止する
2. ✅ Phase 3は明示的な実行指示がある場合のみ開始する
3. ✅ ユーザーに次のアクションを明確に提示する
4. ✅ 既存の安全性ガードレール（テスト必須、1変更1コミット等）は維持

## リスク評価

| リスク | 影響度 | 対策 |
|-------|-------|------|
| 出力形式の変更による混乱 | 低 | 明確な「次のステップ」を提示 |
| ワークフロー分断による使いにくさ | 中 | `/refactor --execute` で再実行可能にする（将来拡張） |
| 既存ユーザーの期待との不一致 | 低 | 安全性優先の設計であり、正しい変更 |

## 次のステップ（実装時）

1. SKILL.md の該当箇所を修正
2. 修正内容をテスト（実際に /refactor を実行して動作確認）
3. 必要に応じて出力メッセージを調整
4. コミット作成

## 参考

- architect スキル: フィードバックループパターン
- breakdown スキル: 「次のステップ」明示パターン
- implement スキル: 実行専用スキルとして分離
- CLAUDE.md: 「不明点があれば積極的に質問する」原則
