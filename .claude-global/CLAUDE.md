# Claude Code ガイドライン

## コーディング哲学

### 設計原則
- 複雑さは問題定義の欠陥を示す。解決策ではなく、問いを再定義する。
- 今必要なものだけを作る。「将来のため」の拡張性は追加しない。
- 一つのことを上手くやる小さな単位を作り、それらを組み合わせる。

### 実装指針
- 名前で意図を表現する。
- 迷ったら可読性を優先する。
- 症状ではなく根本原因を修正する。その場しのぎの回避策は禁止。
- 暗黙のフォールバックは禁止。エラーは明示的に処理する。
- boolean引数は禁止。パラメータで振る舞いを分岐させない。
- 安易なオプショナルは避ける。呼び出し側に意図を表現させる。
- 成果物ごとに表現すべき内容を分ける:
  - コード: How（どう実装するか。コード自体が実装方法を語る）
  - テスト: What（何を期待するか。仕様を表現する）
  - コミットログ: Why（なぜ変更するか。動機と背景を記録する）
  - コメント: Why not（なぜ別の方法を選ばないか。非自明な選択の理由のみ）

### 構造設計
- 最もシンプルな解決策を選ぶ（KISS）。
- 同じ責務のコードは集約する（DRY）。
- 関数内の文は同じ抽象レベルに保つ（SLAP）。
- 1クラス/モジュール、1責務（SRP）。

## インタラクションルール
- 不明点があれば積極的に質問する。
- 選択肢を提示するときは推奨案と理由を添える。
- 回答を生成する前に、不足しているコンテキストを確認する。
- 選択肢の提示や確認には `AskUserQuestion` ツールを使用する。
- ユーザーから行動を修正されたら、再発防止のルール化を提案する。配置先は影響範囲で判断: 全プロジェクト共通 → CLAUDE.md、パス固有 → rules/、個人パターン → memory。

## 作業ルール
- 自動テストがある場合、仕様変更はまずテストに反映する。テストは機能仕様の信頼できるソース。
- プロジェクトで案内されているスクリプトやツールがあれば、それを優先使用する。
- ツールが動作しない場合は、不具合を修正してから作業を進める。
- ツールをバイパスして直接ライブラリを実行することは禁止。
- 可能な限りタスクを並列実行する。

### サブエージェント委譲
- 基本はsonnet。相当軽量なタスク（単純な検索、ファイル存在確認、定型出力の収集等）のみhaiku。
- Task tool で `subagent_type: general-purpose` と `model: sonnet/haiku` を指定。

### 複数ファイル定型処理

**閾値判断**:
- 1-2ファイル: 直接実行
- 3ファイル以上: 計画→実行の分離を検討
- 10ファイル以上: サブエージェント並列化必須

**実行パターン**（優先順）:
1. **ツール活用**: Glob → Grep → 並列 Read/Edit（最優先）
2. **シェル直接**: `for f in *.ext; do ...; done`（単純イテレーション）
3. **find + exec**: 再帰検索・複雑条件
4. **サブエージェント分割**: 5-10ファイルずつ委譲

**必須プラクティス**:
- 段階的スケーリング: 1ファイルで検証 → 全体実行
- 原子的更新: `tmp && mv` パターン（中間状態回避）
- 冪等性: 事前チェックで再実行可能に
- 検証基準明確化: 成功条件をプロンプトに含める

**失敗時**:
- 1ファイル失敗で即停止し報告
- 部分成功の明示: 完了/失敗ファイルをリスト

### 開発スタイル
- `rm` → `rmtrash` で誤削除防止（ディレクトリ削除時は `rmtrash -r` が必要）
