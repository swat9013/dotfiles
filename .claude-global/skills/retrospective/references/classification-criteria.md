# 分類基準リファレンス

retrospective スキルのサブエージェントが知見を正確に分類するための詳細基準。

## TOC

1. [14カテゴリ定義](#14カテゴリ定義)
   - [アーキテクチャ](#アーキテクチャ)
   - [技術選択](#技術選択)
   - [コーディング規約](#コーディング規約)
   - [落とし穴](#落とし穴)
   - [コマンド](#コマンド)
   - [依存関係](#依存関係)
   - [データ構造](#データ構造)
   - [環境・設定](#環境設定)
   - [用語](#用語)
   - [境界条件](#境界条件)
   - [パフォーマンス](#パフォーマンス)
   - [権限設定](#権限設定)
   - [ワークフロー摩擦](#ワークフロー摩擦)
   - [設定改善](#設定改善)
2. [4層保存先の判断基準](#4層保存先の判断基準)
3. [権限設定の判断フロー](#権限設定の判断フロー)
4. [分類チェックリスト](#分類チェックリスト)

---

## 14カテゴリ定義

### アーキテクチャ

**定義**: システムの構造・設計上の決定。コンポーネント間の関係、責務の分担、データフローの全体像。

**探すべきパターン**:
- 「なぜこの構造にしたか」の説明
- 「〜層」「〜モジュール」の役割説明
- ディレクトリ構造の意図
- 「〜はここで管理する」「〜は〜に依存する」という関係の明示

**具体例**: `.claude-global/` は `~/.claude/` へシンボリックリンク／skills/ は明示的呼び出し時のみロード／サブエージェントはTask tool経由で起動し親コンテキストを消費しない

**該当しない例**: 汎用的なアーキテクチャパターン（MVC等）、特定ファイルの実装詳細（→ コーディング規約）

---

### 技術選択

**定義**: 特定のツール・ライブラリ・アプローチを採用した理由とトレードオフ。「なぜXではなくYか」の記録。

**探すべきパターン**:
- 「〜を選んだ理由は」「〜ではなく〜を使う理由」
- 「〜を試したが〜の問題があった」
- 代替案を却下した根拠

**具体例**: sheldon（zsh lazy loading が最も簡潔）／ghostty（GPU レンダリング、設定シンプル）／rmtrash を rm の代わりに使う（誤削除防止）

**該当しない例**: 根拠のない評価、ライブラリのバージョン番号だけ（→ 依存関係）

---

### コーディング規約

**定義**: このプロジェクト固有のコード記述ルール。命名規則、フォーマット、構造パターン。

**探すべきパターン**:
- 「このプロジェクトでは〜する」「〜という命名規則」
- 「〜は禁止」「〜を必ず使う」という明示的な規約
- 既存コードから読み取れる暗黙のパターン

**具体例**: シェルスクリプト先頭に `set -euo pipefail` 必須／関数名は snake_case／SKILL.md は 500 行以下／frontmatter の name は gerund 形式

**該当しない例**: 「変数名はわかりやすくする」（汎用）、言語全般のスタイルガイド、型定義のスキーマ（→ データ構造）

---

### 落とし穴

**定義**: 実際にハマった問題・予期しないエラー・非直感的な挙動。「次回同じ失敗をしないため」の記録。

**探すべきパターン**:
- 「〜でエラーが発生した」「〜が動かなかった」
- 「〜と思ったが実際は〜だった」（期待と現実のギャップ）
- トラブルシューティングで発見した非直感的な動作

**具体例**: macOS lsof 複数条件に `-a` フラグ必須（AND条件）／zsh `$()` 内で PATH 解決失敗→フルパス使用／`> file` だけの行は stdin 待ちでハング→`: > file` を使う／rules の paths は YAML 配列不可、カンマ区切りワンライナーで記述

**該当しない例**: 具体性のない注意事項、実際にハマっていない「理論上の」問題（→ 境界条件）

---

### コマンド

**定義**: 有用なワークフロー・スクリプト・コマンド組み合わせ。再利用可能な操作パターン。

**探すべきパターン**:
- 「〜するには〜コマンドを使う」
- 複数のコマンドを組み合わせた手順
- 「毎回実行する」「定期的に実行する」コマンド

**具体例**: `./lib/dotfilesLink.sh`（シンボリックリンク作成）／`brew bundle --global`（パッケージ更新）／`cck --sub`（サブエージェントクリーンアップ）

**該当しない例**: 一般的な git コマンド、マニュアルに載っている基本的な使い方、一回しか使わない一時的なコマンド

---

### 依存関係

**定義**: 外部 API・ライブラリの制約、バージョン固有の挙動、互換性問題。

**探すべきパターン**:
- 「〜のバージョン〜では〜の挙動」
- 「〜 API の制限」「レート制限」「ページネーション」
- アップグレード時の注意点

**具体例**: Claude Code skills の rules/ paths は #16299 のバグで全件ロード／sheldon のプラグイン設定は TOML 形式、インラインコメント非対応

**該当しない例**: 「〜ライブラリを使う」（理由なし→ 技術選択）、依存関係の一覧だけ

---

### データ構造

**定義**: 重要なスキーマ、型定義、データフローの特性。コードを理解するために必要な構造の知識。

**探すべきパターン**:
- 「〜の型は〜」「〜のスキーマは」
- 「このフィールドは〜を意味する」
- 「〜の形式で渡す必要がある」

**具体例**: settings.json の permissions 構造 `{ "allow": [...], "deny": [...] }` / 各エントリは `"ToolName(pattern)"` 形式／SKILL.md frontmatter 必須フィールド: name, description／retrospective スクリプト出力: JSON Lines（1行1メッセージ）

**該当しない例**: データベースの正規化原則（汎用）、コードを読めばわかる変数の型

---

### 環境・設定

**定義**: 環境変数の意味、設定値の影響、環境差異（ローカル/CI/本番）。

**探すべきパターン**:
- 「〜の環境変数を設定する必要がある」
- 設定ファイルの場所・形式・必須値
- 「〜を有効にするには〜の設定が必要」

**具体例**: `settings.local.json` は .gitignore 対象（プロジェクト固有の権限設定）／`~/.claude/settings.json` と `~/.dotfiles/.claude-global/settings.json` はシンボリックリンクで同一ファイル

**該当しない例**: 「環境変数はコードにハードコードしない」（汎用原則）、一時的な環境設定

---

### 用語

**定義**: プロジェクト固有の概念・ドメイン用語の定義。チーム外の人には通じない可能性がある言葉。

**探すべきパターン**:
- 「〜とは〜のことを指す」「このプロジェクトでの〜の意味は」
- 「〜と〜の違いは」（類似概念の区別）
- 略語・造語の説明

**具体例**: "skill" = Claude Code で呼び出せる再利用可能なワークフロー定義／"Progressive Disclosure" = SKILL.md 本体にはワークフローのみ詳細は references/ に分離する設計原則／retrospective（セッション後に知見を整理・分類）と domain-context（分類済みの知識をファイルに書き込む）の違い

**該当しない例**: IT 業界一般の用語（API、HTTP 等）、文脈なしで理解できる略語

---

### 境界条件

**定義**: エッジケース、想定外入力、許容範囲。「通常は動くが〜の場合は動かない」という条件。

**探すべきパターン**:
- 「〜の場合は動かない」「〜が〜以上になると」
- 「空の場合」「null の場合」の挙動
- 「〜環境のみで発生」という限定条件

**具体例**: SKILL.md 500 行超でロードに影響（コンテキスト圧迫）／CLAUDE.md 150 行超で context-optimizer 自動呼び出し／`skills/**` は skills/ 直下のファイルを含まない

**該当しない例**: 「入力値のバリデーションが必要」（汎用原則）、実際に確認していない理論上の境界条件（→ 落とし穴）

---

### パフォーマンス

**定義**: ボトルネック、最適化済み箇所、N+1 等の注意点。「なぜこのアプローチか」の性能的根拠。

**探すべきパターン**:
- 「〜が遅い原因は」「〜でボトルネックが発生した」
- 「〜の代わりに〜を使う（速いから）」
- 「〜はキャッシュされる/されない」

**具体例**: rules/ は #16299 のバグで全件ロード→ファイル数・サイズを最小限に／サブエージェント（Task tool）は親コンテキストを消費しない→重い分析はサブエージェントに委譲

**該当しない例**: 「効率的なコードを書く」（汎用原則）、計測せずに推測したボトルネック

---

### 権限設定

**定義**: Claude Code の allow/ask/deny 設定の最適化に関する知見。「毎回許可/拒否した操作」「自律実行で問題のあった操作」の記録。

**探すべきパターン**:
- 「毎回 ask されたが毎回許可した」操作
- 「自動実行されて問題が発生した」操作
- 「〜コマンドは常に実行してよい」という運用上の知見

**具体例**:
```
# allow 追加候補（毎回許可していた操作）
- Bash(git status) → allow: セッションで10回以上確認され、毎回許可
- Bash(cat ~/.zshrc) → allow: 設定確認は常に安全

# deny 追加候補（問題が発生した操作）
- Bash(rm -rf *) → deny: 意図しない削除が発生
- Bash(git push --force) → deny: 自律実行には不適切

# ask 維持（影響範囲が大きい操作）
- Bash(brew install *) → ask: 環境変更は確認必要
- Write(~/.zshrc) → ask: システム設定ファイルの変更は確認
```

**該当しない例**: 「セキュリティに注意する」（汎用原則）、一度だけ使った特殊なコマンドの権限

---

### ワークフロー摩擦

**定義**: 繰り返し手動実行したパターン・非効率な操作フロー。スキル化・自動化の候補。

**探すべきパターン**:
- セッション中に同じ操作を 3 回以上繰り返した
- 「毎回〜する必要がある」という言及
- 「〜が面倒」「〜を自動化したい」という発言

**具体例**: セッション後の振り返りを毎回手動実行 → retrospective スキルとして自動化／新プロジェクトのセットアップを毎回手動実行 → project-setup スキル化候補

**該当しない例**: 一回だけ実行した複雑な操作、ユーザー固有判断が必要な作業、コマンドの記録だけ（→ コマンド）

---

### 設定改善

**定義**: Claude Code の設定変更候補。hooks の追加、statusline の改善、MCP の追加・変更。

**探すべきパターン**:
- 「〜が自動でできれば」「〜のたびに手動で〜する」（→ hooks 化候補）
- 「ステータスラインに〜を表示したい」
- 「〜の MCP があれば便利」

**具体例**: Stop hook: セッション終了時に retrospective を自動提案 `{ "event": "Stop", "command": "..." }`／現在のセッション消費トークン数を statusline に表示／〜の MCP サーバーを追加

**該当しない例**: ワークフロー手順の改善（→ ワークフロー摩擦）、権限変更（→ 権限設定）

---

## 4層保存先の判断基準

### CLAUDE.md

**判断基準**: プロジェクト全体に常時必要なドメイン知識。すべてのセッションで参照される情報。

| 適用範囲 | 参照頻度 | 内容 |
|---------|---------|------|
| プロジェクト全体 | 毎セッション必要 | アーキテクチャ・方針・Gotchas |
| 特定パスのみ → rules/ | 特定タスク時のみ → rules/ or 破棄 | 詳細手順 → rules/ or skills/ |

**記入場所**: アーキテクチャ概要 → 「アーキテクチャ概要」セクション／主要コマンド → 「主要コマンド」セクション／非直感的な挙動 → 「Gotchas」セクション

---

### rules/

**判断基準**: 特定のファイルパスに紐づくルール・規約。glob パターンで対象が明確に絞れる。

| 条件 | rules/ に保存 | CLAUDE.md に保存 |
|------|--------------|----------------|
| 適用対象 | 特定パス（`*.sh`, `skills/**`等） | プロジェクト全体 |
| 参照タイミング | 該当ファイル編集時 | 常時 |

**glob パターン例**: `**/*.sh`（シェルスクリプト）／`.claude-global/skills/**`（スキルファイル）／`**/*.test.*, **/*.spec.*`（テストファイル）

**ファイル命名**: kebab-case、役割を明確に（例: `shell-scripting.md`）

**記入例**:
```markdown
---
paths: **/*.sh
---
- 先頭に `set -euo pipefail`
- 関数名は snake_case
- `rm` 禁止 → `rmtrash` を使う
```

---

### skills/

**判断基準**: 3 ステップ以上の再利用可能な手順。サブエージェント呼び出しを含む複合ワークフロー。

| 条件 | skills/ に保存 | rules/ に保存 |
|------|--------------|--------------|
| ステップ数 | 3 ステップ以上 | 単純なルール列挙 |
| 実行形式 | インタラクティブ・サブエージェント呼び出し | 参照・制約 |

**スキル化の判断**: 毎回同じ手順を実行している／3 ステップ以上の手順がある／サブエージェントを呼び出す必要がある

**記入例**: frontmatter に `name: project-setup`, `description: 新規プロジェクトのClaude Code設定を初期化する。「プロジェクト初期化」「setup」と依頼された時に使用。` を記載

---

### settings.local.json

**判断基準**: Claude Code の自律性・権限設定の最適化。allow/ask/deny リストの追加・変更。

| 対象 | allow | ask | deny |
|------|-------|-----|------|
| 毎回許可していた操作 | ○ | - | - |
| 影響範囲が大きい操作 | - | ○ | - |
| 問題が発生した操作 | - | - | ○ |

**ファイル構造**:
```json
{
  "permissions": {
    "allow": ["Bash(git status)", "Bash(git diff*)", "Read(~/.zshrc)"],
    "deny": ["Bash(rm -rf*)", "Bash(git push --force*)"]
  }
}
```

**注意**: `settings.local.json` は `.gitignore` 対象。

---

### 破棄

以下に該当する知見は保存しない。

| 理由 | 例 |
|------|-----|
| 汎用的なベストプラクティス | 「変数名はわかりやすくする」 |
| セッション固有のコンテキスト | 「今日のタスクは〜」 |
| 一時的な作業メモ | 「あとで〜を確認する」「TODO: 〜」 |
| Claude Code の一般的な使い方 | 「Task tool でサブエージェントを起動できる」 |
| 既存ファイルに記載済み | CLAUDE.md や rules/ に既に同じ内容がある |
| 推測・仮説 | 「おそらく〜だと思う」 |
| プロジェクト固有でない知識 | 言語仕様、ライブラリのドキュメント |

**判断の問い**: 「次のセッションで知らないと困るか？」「このプロジェクト固有の知識か？」「他のドキュメントを見ればわかるか？」「1ヶ月後も有効な情報か？」→ いずれか No/Yes なら破棄

---

## 権限設定の判断フロー

**ask 回数による判断**:
- 0回: 判断不要（現状維持）
- 1-2回: 内容を確認 → 毎回許可かつ安全 → allow 候補 / 影響大 → ask 維持 / 1回でも拒否 → deny 検討
- 3回以上: 強い候補 → 毎回許可かつリスク小 → allow 推奨 / リスク大 → ask 維持 / 問題発生 → deny 推奨

**allow 追加の安全チェック**:
- [ ] 操作が冪等か（何度実行しても副作用が同じ）
- [ ] 読み取り専用か、または変更が限定的か
- [ ] 実行範囲が明確なパターンで指定できるか

**deny 追加の判断**:
- [ ] 実際に問題が発生したか（推測でなく実績）
- [ ] 代替手段があるか（deny すると作業が止まらないか）

---

## 分類チェックリスト

知見を見つけたら以下の順で判断する:

```
1. プロジェクト固有か？
   No → 破棄

2. カテゴリを特定
   - 構造・設計の話 → アーキテクチャ
   - 「なぜXでなくY」 → 技術選択
   - コードの書き方ルール → コーディング規約
   - 実際にハマった → 落とし穴
   - 再利用できるコマンド手順 → コマンド
   - 外部依存の制約 → 依存関係
   - データ形式・スキーマ → データ構造
   - 環境変数・設定ファイル → 環境・設定
   - プロジェクト固有の概念 → 用語
   - 「〜の場合は動かない」 → 境界条件
   - 速度・メモリ・効率 → パフォーマンス
   - allow/ask/deny の最適化 → 権限設定
   - 「毎回手動でやった」 → ワークフロー摩擦
   - hooks/statusline/MCP → 設定改善

3. 保存先を決定
   - 全体・常時必要 → CLAUDE.md
   - 特定パスに紐づく → rules/（glob パターンが指定できるか確認）
   - 3 ステップ以上の手順 → skills/
   - allow/ask/deny の変更 → settings.local.json
   - 上記に当てはまらない → 破棄
```
