# 安全性チェックリスト

リファクタリング実行前後に確認すべき安全性項目。

## Phase 1: 実行前チェック

### バージョン管理

- [ ] 対象コードがGit管理下にある
- [ ] 作業ブランチを作成済み
- [ ] 未コミットの変更がない（クリーンな状態）

### テスト

- [ ] テストの有無を確認済み
- [ ] テストなしの場合、対応方針を決定済み
  - [ ] Characterization Test作成
  - [ ] リスク受容（ユーザー承認済み）
  - [ ] 中止

### 影響範囲

- [ ] 参照元を特定済み
- [ ] 影響ファイル数を把握済み
- [ ] HIGH影響の場合、ステップを細分化済み

---

## Phase 2: 各ステップ実行時

### 変更前

- [ ] ベースラインテストが通ることを確認
- [ ] 変更内容が1つの論理的変更に収まっている
- [ ] ロールバック可能な状態（コミット済み）

### 変更後

- [ ] テストが全て通る
- [ ] Lintが通る
- [ ] 型チェックが通る（該当する場合）
- [ ] コミットメッセージが規約に従っている

### 失敗時

- [ ] 即座にロールバック（`git checkout .`）
- [ ] 失敗原因を分析
- [ ] ステップを再分割、または方針を再検討

---

## Phase 3: 完了時チェック

### 機能確認

- [ ] 全テストが通過
- [ ] 手動テスト実施（必要に応じて）
- [ ] 振る舞いが保存されている

### コード品質

- [ ] 検出したスメルが解消されている
- [ ] 新しいスメルを導入していない
- [ ] コードの可読性が向上している

### ドキュメント

- [ ] refactor-plan.mdのステータスを更新
- [ ] 必要に応じてコメント/ドキュメントを更新

---

## リスクレベル別対応

### CRITICAL（テストNONE + 影響HIGH）

**必須アクション**:
1. Characterization Testの作成を強く推奨
2. ユーザーにリスクを明示的に説明
3. リスク受容の場合、書面（コメント等）で承認を記録
4. ステップを最小単位に分割

**禁止事項**:
- 複数の変更を1コミットにまとめる
- テストなしで大規模変更を実行

### HIGH（テストLOW + 影響MEDIUM以上）

**必須アクション**:
1. ステップを細分化
2. 各ステップ後に手動確認を追加
3. ユーザーに進捗を報告

### NORMAL

**通常フロー**:
1. 計画通りに実行
2. 品質ゲートをクリア
3. 完了報告

---

## ロールバック手順

### 単一ステップのロールバック

```bash
# 未コミットの変更を破棄
git checkout .

# ステージングも破棄
git reset HEAD .
```

### 複数ステップのロールバック

```bash
# 直近のコミット一覧を確認
git log --oneline -10

# 特定のコミットまで戻す（変更は保持）
git reset --soft <commit_hash>

# 特定のコミットまで戻す（変更も破棄）
git reset --hard <commit_hash>
```

### ロールバックポイントの記録

各フェーズ開始前にタグを作成:

```bash
git tag refactor-checkpoint-phase1
git tag refactor-checkpoint-phase2
```

---

## 安全性違反の兆候

以下の兆候がある場合、作業を一時停止して再評価:

| 兆候 | 対応 |
|------|------|
| テストが予期せず失敗 | 即座にロールバック、原因調査 |
| 影響範囲が想定より広い | ステップ再分割 |
| 「ついでに」別の修正をしたくなる | 別コミットに分離 |
| 変更が大きくなりすぎている | 分割して再実行 |
| 不安を感じる | ユーザーに相談 |

---

## コミットメッセージテンプレート

```
refactor: [手法名] - [対象]

- Before: [変更前の状態]
- After: [変更後の状態]
- Technique: [適用した手法]
- Smell: [解消したスメル]

[追加の説明があれば]
```

### 例

```
refactor: Extract Method - calculateTotal

- Before: 50行のメソッドに計算ロジックが埋め込まれていた
- After: calculateSubtotal, applyDiscount, addTaxを抽出
- Technique: Extract Method
- Smell: Long Method

計算ロジックを分離することで、個別にテスト可能に。
```
