# 分類基準リファレンス

retrospective スキルのサブエージェントが知見を正確に分類するための詳細基準。

## TOC

1. [14カテゴリ定義](#14カテゴリ定義)
   - [アーキテクチャ](#アーキテクチャ)
   - [技術選択](#技術選択)
   - [コーディング規約](#コーディング規約)
   - [落とし穴](#落とし穴)
   - [コマンド](#コマンド)
   - [依存関係](#依存関係)
   - [データ構造](#データ構造)
   - [環境・設定](#環境設定)
   - [用語](#用語)
   - [境界条件](#境界条件)
   - [パフォーマンス](#パフォーマンス)
   - [権限設定](#権限設定)
   - [ワークフロー摩擦](#ワークフロー摩擦)
   - [設定改善](#設定改善)
2. [4層保存先の判断基準](#4層保存先の判断基準)
   - [CLAUDE.md](#claudemd)
   - [rules/](#rules)
   - [skills/](#skills)
   - [settings.local.json](#settingslocaljson)
   - [破棄](#破棄)
3. [権限設定の判断フロー](#権限設定の判断フロー)
4. [分類チェックリスト](#分類チェックリスト)

---

## 14カテゴリ定義

### アーキテクチャ

**定義**: システムの構造・設計上の決定。コンポーネント間の関係、責務の分担、データフローの全体像。

**探すべきパターン**:
- 「なぜこの構造にしたか」の説明
- 「〜層」「〜モジュール」「〜コンポーネント」の役割説明
- ディレクトリ構造の意図についての言及
- 「〜はここで管理する」「〜は〜に依存する」という関係の明示

**具体例**:
```
# CLAUDE.md Gotchas セクションへ
- `.claude-global/` は `~/.claude/` へシンボリックリンクされる
- skills/ は明示的呼び出し時のみロード（常時ロードのCLAUDE.mdと異なる）
- サブエージェントはTask tool経由で起動し、親コンテキストを消費しない
```

**該当しない例**:
- 「MVCパターンを使う」（汎用的なアーキテクチャパターン、プロジェクト固有でない）
- 「関心の分離を意識する」（一般的な原則）
- 特定ファイルの実装詳細（→ コーディング規約 または データ構造）

---

### 技術選択

**定義**: 特定のツール・ライブラリ・アプローチを採用した理由とトレードオフ。「なぜXではなくYか」の記録。

**探すべきパターン**:
- 「〜を選んだ理由は」「〜ではなく〜を使う理由」
- 「〜を試したが〜の問題があった」
- 「〜との比較検討」
- 代替案を却下した根拠

**具体例**:
```
# CLAUDE.md Gotchas セクションへ
- sheldon を使う理由: zsh プラグイン管理で lazy loading が最も簡潔
- ghostty を選択: GPU レンダリングによる高速描画、設定ファイルがシンプル
- rmtrash を rm の代わりに使う: 誤削除防止（ゴミ箱経由）
```

**該当しない例**:
- 「React は人気があるから」（プロジェクト固有の理由がない）
- 「パフォーマンスが良い」（根拠のない評価）
- ライブラリのバージョン番号だけ（→ 依存関係）

---

### コーディング規約

**定義**: このプロジェクト固有のコード記述ルール。命名規則、フォーマット、構造パターン。

**探すべきパターン**:
- 「このプロジェクトでは〜する」「〜という命名規則」
- レビュー指摘から生まれた統一ルール
- 「〜は禁止」「〜を必ず使う」という明示的な規約
- 既存コードから読み取れる暗黙のパターン

**具体例**:
```
# rules/shell.md へ（paths: **/*.sh）
- シェルスクリプトのエラーハンドリング: set -euo pipefail を先頭に必ず記載
- 関数名は kebab-case ではなく snake_case（例: find_session）
- コメントは英語ではなく日本語で記述

# rules/skills.md へ（paths: .claude-global/skills/**）
- SKILL.md は 500 行以下
- frontmatter の name は gerund 形式推奨
```

**該当しない例**:
- 「変数名はわかりやすくする」（汎用的すぎる）
- 言語全般のスタイルガイド（プロジェクト固有でない）
- 型定義のスキーマ（→ データ構造）

---

### 落とし穴

**定義**: 実際にハマった問題・予期しないエラー・非直感的な挙動。「次回同じ失敗をしないため」の記録。

**探すべきパターン**:
- 「〜でエラーが発生した」「〜が動かなかった」
- 「〜と思ったが実際は〜だった」（期待と現実のギャップ）
- 「〜に注意」「〜を忘れずに」という警告
- トラブルシューティングで発見した非直感的な動作

**具体例**:
```
# CLAUDE.md Gotchas セクションへ
- macOS lsof の複数条件: -a フラグ必須（AND条件）。lsof -a -d cwd -p $pid
- zsh サブシェル内 PATH: $() 内で PATH 解決失敗の可能性。フルパス使用
- zsh NULLCMD の罠: `> file` だけの行は stdin 待ちでハング。`: > file` を使う
- rules の paths 記法: YAML 配列（ハイフン複数行）は適用されない。カンマ区切りワンライナー
```

**該当しない例**:
- 「〜は使い方に注意が必要」（具体性がない）
- 一般的なセキュリティ注意事項
- 実際にハマっていない「理論上の」問題（→ 境界条件）

---

### コマンド

**定義**: 有用なワークフロー・スクリプト・コマンド組み合わせ。再利用可能な操作パターン。

**探すべきパターン**:
- 「〜するには〜コマンドを使う」
- 複数のコマンドを組み合わせた手順
- 「毎回実行する」「定期的に実行する」コマンド
- スクリプト化された操作フロー

**具体例**:
```
# CLAUDE.md 主要コマンドセクションへ
- ./lib/dotfilesLink.sh: シンボリックリンク作成・再作成
- brew bundle --global: Homebrew パッケージ更新
- cck --sub: サブエージェントのクリーンアップ

# rules/ または skills/ へ（3ステップ以上なら skills/）
- セッション特定: ~/.dotfiles/.claude-global/skills/retrospective/scripts/find-sessions.sh
```

**該当しない例**:
- 一般的な git コマンド（`git status` など）
- ツールの基本的な使い方（マニュアルに載っている内容）
- 一回しか使わない一時的なコマンド

---

### 依存関係

**定義**: 外部 API・ライブラリの制約、バージョン固有の挙動、互換性問題。

**探すべきパターン**:
- 「〜のバージョン〜では〜の挙動」
- 「〜 API の制限」「レート制限」「ページネーション」
- 「〜に依存しているため〜できない」
- アップグレード時の注意点

**具体例**:
```
# CLAUDE.md Gotchas セクションへ
- Claude Code skills: rules/ の paths は #16299 のバグで全件ロードされる
- sheldon: プラグイン設定は TOML 形式、インラインコメント非対応
- Homebrew bundle: --global フラグで ~/.Brewfile を参照
```

**該当しない例**:
- 「〜ライブラリを使う」（技術選択の理由がない場合は → 技術選択）
- 依存関係の一覧だけ（package.json 等に記載済みの内容）
- バージョン番号の記録（→ Gotchas に制約と一緒に記載）

---

### データ構造

**定義**: 重要なスキーマ、型定義、データフローの特性。コードを理解するために必要な構造の知識。

**探すべきパターン**:
- 「〜の型は〜」「〜のスキーマは」
- 「このフィールドは〜を意味する」
- 複雑なネスト構造の説明
- 「〜の形式で渡す必要がある」

**具体例**:
```
# CLAUDE.md または rules/ へ
- settings.json の permissions 構造:
  { "allow": [...], "deny": [...] }
  各エントリは "ToolName(pattern)" 形式
- SKILL.md frontmatter の必須フィールド: name, description
- retrospective スクリプトの出力形式: JSON Lines（1行1メッセージ）
```

**該当しない例**:
- データベースの正規化原則（汎用的）
- 実装詳細としての変数の型（コードを読めばわかる）
- 一時的なデータ変換の中間形式

---

### 環境・設定

**定義**: 環境変数の意味、設定値の影響、環境差異（ローカル/CI/本番）。

**探すべきパターン**:
- 「〜の環境変数を設定する必要がある」
- 「〜環境では〜が異なる」
- 設定ファイルの場所・形式・必須値
- 「〜を有効にするには〜の設定が必要」

**具体例**:
```
# CLAUDE.md Gotchas セクションへ
- settings.local.json は .gitignore 対象（プロジェクト固有の権限設定）
- ~/.claude/settings.json と ~/.dotfiles/.claude-global/settings.json は
  シンボリックリンクで同一ファイル
- MCP サーバーは settings.json の mcpServers で登録、
  settings.local.json でローカル上書き可能
```

**該当しない例**:
- 「環境変数はコードにハードコードしない」（汎用原則）
- OS レベルの一般的な設定（macOS の一般設定等）
- 一時的な環境設定（セッション内のみ有効な変更）

---

### 用語

**定義**: プロジェクト固有の概念・ドメイン用語の定義。チーム外の人には通じない可能性がある言葉。

**探すべきパターン**:
- 「〜とは〜のことを指す」
- 「このプロジェクトでの〜の意味は」
- 「〜と〜の違いは」（類似概念の区別）
- 略語・造語の説明

**具体例**:
```
# CLAUDE.md または rules/ へ
- "skill" = Claude Code で呼び出せる再利用可能なワークフロー定義
- "Progressive Disclosure" = SKILL.md 本体にはワークフローのみ、
  詳細は references/ に分離する設計原則
- "domain-context" = このプロジェクトで claude-code が学んだ知識を永続化するスキル
- "retrospective" と "domain-context" の違い:
  retrospective = セッション後に知見を整理・分類するワークフロー
  domain-context = 分類済みの知識をファイルに書き込むスキル
```

**該当しない例**:
- IT 業界全般の一般用語（API、HTTP、JSON 等）
- 英語の一般的な技術用語
- 文脈なしで理解できる略語

---

### 境界条件

**定義**: エッジケース、想定外入力、許容範囲。「通常は動くが〜の場合は動かない」という条件。

**探すべきパターン**:
- 「〜の場合は動かない」「〜が〜以上になると」
- 「空の場合」「null の場合」「0 の場合」の挙動
- 「〜文字以上は〜する」といった制限値
- 「〜環境のみで発生」という限定条件

**具体例**:
```
# CLAUDE.md Gotchas セクションへ
- SKILL.md: 500 行超で skills/ のロードに影響（コンテキスト圧迫）
- CLAUDE.md: 150 行超で context-optimizer を自動呼び出し
- rules/ の paths: ワイルドカードの `**` は 1 階層以上を意味する
  （`skills/**` は skills/ 直下のファイルは含まない）
- extract-messages.sh: セッションファイルが存在しない場合は空出力
```

**該当しない例**:
- 「入力値のバリデーションが必要」（汎用的な原則）
- 想定内の通常のエラーハンドリング
- 実際に確認していない理論上の境界条件（→ 落とし穴）

---

### パフォーマンス

**定義**: ボトルネック、最適化済み箇所、N+1 等の注意点。「なぜこのアプローチか」の性能的根拠。

**探すべきパターン**:
- 「〜が遅い原因は」「〜でボトルネックが発生した」
- 「〜の代わりに〜を使う（速いから）」
- 「〜回以上は並列処理が必要」
- 「〜はキャッシュされる/されない」

**具体例**:
```
# CLAUDE.md または rules/ へ
- rules/ は #16299 のバグで全件ロードされる: ファイル数・サイズを最小限に
- サブエージェント（Task tool）は親コンテキストを消費しない:
  重い分析はサブエージェントに委譲
- 10 ファイル以上の並列処理: サブエージェント分割が必須
```

**該当しない例**:
- 「効率的なコードを書く」（汎用原則）
- 計測せずに推測したボトルネック
- フロントエンドの一般的な最適化テクニック（プロジェクト固有でない）

---

### 権限設定

**定義**: Claude Code の allow/ask/deny 設定の最適化に関する知見。「毎回許可/拒否した操作」「自律実行で問題のあった操作」の記録。

**探すべきパターン**:
- 「毎回 ask されたが毎回許可した」操作
- 「自動実行されたが問題なかった」操作
- 「自動実行されて問題が発生した」操作
- 「この操作は必ず確認が必要」という判断
- 「〜コマンドは常に実行してよい」という運用上の知見

**具体例**:
```
# settings.local.json へ

# allow 追加候補（毎回許可していた操作）
- Bash(git status) → allow: セッションで10回以上確認され、毎回許可
- Bash(cat ~/.zshrc) → allow: 設定確認は常に安全

# deny 追加候補（問題が発生した操作）
- Bash(rm -rf *) → deny: 意図しない削除が発生
- Bash(git push --force) → deny: 自律実行には不適切

# ask 維持（影響範囲が大きい操作）
- Bash(brew install *) → ask: 環境変更は確認必要
- Write(~/.zshrc) → ask: システム設定ファイルの変更は確認
```

**該当しない例**:
- 「セキュリティに注意する」（汎用原則）
- 一度だけ使った特殊なコマンドの権限
- Claude Code の一般的な権限モデルの説明
- アーキテクチャ上の判断（→ アーキテクチャ）

---

### ワークフロー摩擦

**定義**: 繰り返し手動実行したパターン・非効率な操作フロー。スキル化・自動化の候補。

**探すべきパターン**:
- セッション中に同じ操作を 3 回以上繰り返した
- 「毎回〜する必要がある」という言及
- 複数のステップを毎回手動で実行している
- 「〜が面倒」「〜を自動化したい」という発言
- 定型的なチェックリスト作業

**具体例**:
```
# skills/ 新規作成候補

# 例1: セッション後の振り返りを毎回手動実行していた
→ retrospective スキルとして自動化
  トリガー: 「振り返り」「retrospective」

# 例2: 新しいプロジェクトのセットアップを毎回手動実行
→ project-setup スキル化候補
  手順: CLAUDE.md 作成 → .claude/rules/ 作成 → 初期設定

# 例3: PR レビューの確認項目を毎回思い出しながら実行
→ code-review スキルのチェックリスト追加候補
```

**該当しない例**:
- 一回だけ実行した複雑な操作
- ツール固有の一般的な使い方
- 効率化できない性質の作業（ユーザー固有判断が必要な作業）
- コマンドの記録だけ（→ コマンド）

---

### 設定改善

**定義**: Claude Code の設定変更候補。hooks の追加、statusline の改善、MCP の追加・変更。

**探すべきパターン**:
- 「〜が自動でできれば」という要望
- 「〜のたびに手動で〜する」（→ hooks 化候補）
- 「ステータスラインに〜を表示したい」
- 「〜の MCP があれば便利」
- 「〜イベントで〜を実行できるか」

**具体例**:
```
# settings.json または hooks/ へ

# hooks 追加候補
- Stop hook: セッション終了時に retrospective を自動提案
  { "event": "Stop", "command": "echo '振り返りを実行しますか？'" }
- PostToolUse hook: 大量ファイル変更後に確認
  { "event": "PostToolUse", "matcher": "Write", "command": "..." }

# statusline 改善候補
- 現在のセッション消費トークン数を表示
- アクティブなサブエージェント数を表示

# MCP 設定変更候補
- 〜の MCP サーバーを追加（用途: 〜）
- 既存 MCP の設定パラメータ変更
```

**該当しない例**:
- ワークフロー手順の改善（→ ワークフロー摩擦）
- Claude Code の動作に関係しない OS レベルの設定
- 一時的な設定変更（セッション内のみ）
- 権限変更（→ 権限設定）

---

## 4層保存先の判断基準

### CLAUDE.md

**判断基準**: プロジェクト全体に常時必要なドメイン知識。すべてのセッションで参照される情報。

| 条件 | 保存する | 保存しない |
|------|---------|-----------|
| 適用範囲 | プロジェクト全体 | 特定のファイル/ディレクトリのみ |
| 参照頻度 | 毎セッション必要 | 特定タスク時のみ |
| 内容の性質 | アーキテクチャ・方針・Gotchas | 詳細手順・参照マニュアル |

**記入場所の選択**:
- アーキテクチャ概要 → 「アーキテクチャ概要」セクション
- 主要コマンド → 「主要コマンド」セクション
- 非直感的な挙動・注意点 → 「Gotchas」セクション
- プロジェクト固有の制約 → 該当するセクションまたは新規セクション

**具体的な記入例**:
```markdown
## Gotchas

- **コマンド名衝突**: `cc*` 系は既存エイリアス確認必須（例: `ccs`=`claude --model sonnet`）
- **zsh NULLCMD の罠**: `> file` だけの行は stdin 待ちでハング。解決策: `: > file`
- **rules の paths 記法**: YAML 配列は適用されない。カンマ区切りワンライナーで記述
```

---

### rules/

**判断基準**: 特定のファイルパスに紐づくルール・規約。glob パターンで対象が明確に絞れる。

| 条件 | rules/ に保存 | CLAUDE.md に保存 |
|------|--------------|----------------|
| 適用対象 | 特定パス（`*.sh`, `skills/**`等） | プロジェクト全体 |
| 内容 | コーディング規約・制約 | 全体方針・概要 |
| 参照タイミング | 該当ファイル編集時 | 常時 |

**glob パターン例**:
```yaml
paths: **/*.sh                          # シェルスクリプト全体
paths: .claude-global/skills/**         # スキルファイル全体
paths: **/*.test.*, **/*.spec.*         # テストファイル
paths: src/api/**                       # API 層のみ
paths: docs/**                          # ドキュメント全体
```

**ファイル命名規則**: kebab-case、役割を明確に（例: `shell-scripting.md`, `skills-design.md`）

**具体的な記入例**:
```markdown
---
paths: **/*.sh
---

# シェルスクリプト規約

## 必須
- 先頭に `set -euo pipefail`
- 関数名は snake_case
- エラーメッセージは stderr へ: `echo "error: ..." >&2`

## 禁止
- `rm` の直接使用（→ `rmtrash` を使う）
- グローバル変数（ローカル変数に `local` を付ける）
```

---

### skills/

**判断基準**: 3 ステップ以上の再利用可能な手順。サブエージェント呼び出しを含む複合ワークフロー。

| 条件 | skills/ に保存 | rules/ に保存 |
|------|--------------|--------------|
| ステップ数 | 3 ステップ以上 | 単純なルール列挙 |
| 実行形式 | インタラクティブ・サブエージェント呼び出し | 参照・制約 |
| 再利用性 | 明示的に呼び出して使う | 作業中に自動参照 |

**スキル化の判断基準**:
1. 「毎回同じ手順を実行している」→ スキル化候補
2. 「3 ステップ以上の手順がある」→ スキル化候補
3. 「サブエージェントを呼び出す必要がある」→ スキル化必須

**具体的な記入例（SKILL.md 冒頭）**:
```markdown
---
name: project-setup
description: 新規プロジェクトのClaude Code設定を初期化する。「プロジェクト初期化」「setup」「新規プロジェクト」と依頼された時に使用。
disable-model-invocation: true
---

# Project Setup

## 手順

### 1. CLAUDE.md 作成
...
### 2. rules/ 初期化
...
### 3. .gitignore 更新
...
```

---

### settings.local.json

**判断基準**: Claude Code の自律性・権限設定の最適化。allow/ask/deny リストの追加・変更。

| 対象 | allow | ask | deny |
|------|-------|-----|------|
| 毎回許可していた操作 | ○ | - | - |
| 影響範囲が大きい操作 | - | ○ | - |
| 問題が発生した操作 | - | - | ○ |
| システム破壊リスクがある操作 | - | - | ○ |

**ファイル構造**:
```json
{
  "permissions": {
    "allow": [
      "Bash(git status)",
      "Bash(git diff*)",
      "Read(~/.zshrc)"
    ],
    "deny": [
      "Bash(rm -rf*)",
      "Bash(git push --force*)"
    ]
  }
}
```

**注意**: `settings.local.json` は `.gitignore` 対象。環境固有の設定を記録する。

---

### 破棄

以下に該当する知見は保存しない。

**破棄基準**:

| 理由 | 例 |
|------|-----|
| 汎用的なベストプラクティス | 「変数名はわかりやすくする」「エラーハンドリングをする」 |
| セッション固有のコンテキスト | 「今日のタスクは〜」「一時的に〜を変更した」 |
| 一時的な作業メモ | 「あとで〜を確認する」「TODO: 〜」 |
| Claude Code の一般的な使い方 | 「Task tool でサブエージェントを起動できる」 |
| 既存ファイルに記載済み | CLAUDE.md や rules/ に既に同じ内容がある |
| 推測・仮説 | 「おそらく〜だと思う」（確認済みでない情報） |
| プロジェクト固有でない知識 | 言語仕様、ライブラリのドキュメントに載っている内容 |

**判断の問い**:
1. 「次のセッションで知らないと困るか？」→ No なら破棄
2. 「このプロジェクト固有の知識か？」→ No なら破棄
3. 「他のドキュメントを見ればわかるか？」→ Yes なら破棄
4. 「1ヶ月後も有効な情報か？」→ No なら破棄

---

## 権限設定の判断フロー

```
操作を特定する
     |
     v
セッション中に何回 ask されたか？
     |
     +-- 0回 -----> 判断不要（現状維持）
     |
     +-- 1-2回 ---> 内容を確認
     |                   |
     |                   +-- 毎回許可 AND 安全な操作 ---> allow 追加候補
     |                   |
     |                   +-- 毎回許可 AND 影響大 -------> ask 維持
     |                   |
     |                   +-- 1回でも拒否 -----------------> deny 追加候補を検討
     |
     +-- 3回以上 -> 強い候補
                        |
                        +-- 毎回許可 AND リスク小 -------> allow 追加（推奨）
                        |
                        +-- 毎回許可 AND リスク大 -------> ask 維持
                        |
                        +-- 問題が発生 ------------------> deny 追加（推奨）
```

**allow 追加の安全チェック**:
- [ ] 操作が冪等か（何度実行しても副作用が同じ）
- [ ] 読み取り専用か、または変更が限定的か
- [ ] 実行範囲が明確なパターンで指定できるか
- [ ] 意図しない副作用のリスクが低いか

**deny 追加の判断**:
- [ ] 実際に問題が発生したか（推測でなく実績）
- [ ] 代替手段があるか（deny すると作業が止まらないか）
- [ ] より細かいパターンで allow する方が適切でないか

---

## 分類チェックリスト

知見を見つけたら以下の順で判断する:

```
1. プロジェクト固有か？
   No → 破棄

2. カテゴリを特定
   - 構造・設計の話 → アーキテクチャ
   - 「なぜXでなくY」 → 技術選択
   - コードの書き方ルール → コーディング規約
   - 実際にハマった → 落とし穴
   - 再利用できるコマンド手順 → コマンド
   - 外部依存の制約 → 依存関係
   - データ形式・スキーマ → データ構造
   - 環境変数・設定ファイル → 環境・設定
   - プロジェクト固有の概念 → 用語
   - 「〜の場合は動かない」 → 境界条件
   - 速度・メモリ・効率 → パフォーマンス
   - allow/ask/deny の最適化 → 権限設定
   - 「毎回手動でやった」 → ワークフロー摩擦
   - hooks/statusline/MCP → 設定改善

3. 保存先を決定
   - 全体・常時必要 → CLAUDE.md
   - 特定パスに紐づく → rules/（glob パターンが指定できるか確認）
   - 3 ステップ以上の手順 → skills/
   - allow/ask/deny の変更 → settings.local.json
   - 上記に当てはまらない → 破棄
```
