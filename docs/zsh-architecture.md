# Zsh設定アーキテクチャ

## 設計思想

### 1. パフォーマンス優先

シェル起動時間を最小化するため、以下の原則を採用：

- **遅延読み込み**: 重いプラグイン（syntax-highlighting等）は`zsh-defer`で遅延実行
- **バックグラウンド処理**: ネットワークを使う処理（auto_update.sh）は`&!`でバックグラウンド実行
- **条件付き読み込み**: コマンドが存在する場合のみ関連設定を読み込み
- **軽量プラグインマネージャー**: Oh-My-ZshではなくSheldon（Rust製）を採用

### 2. モジュール分離

設定を機能別に分離し、保守性を向上：

```
.zshenv          # 環境変数（全シェルで読み込み）
.zshrc           # インタラクティブシェル設定
.zsh/
  ├── opt.zsh      # シェルオプション・履歴設定
  ├── keybinds.zsh # キーバインド・peco統合
  └── aliases.zsh  # エイリアス・関数定義
sheldon/
  └── plugins.toml # プラグイン管理
starship/
  └── starship.toml # プロンプト設定
```

### 3. クロスプラットフォーム対応

macOSとLinuxの両方で動作するよう、OS検出による条件分岐を使用。

---

## ファイル構成と役割

### `.zshenv` - 環境変数

**読み込みタイミング**: 全てのzshセッション（スクリプト実行時も含む）

**配置すべき内容**:
- ロケール設定（LANG, LC_ALL）
- エディタ設定（EDITOR, VISUAL）
- プラットフォーム固有の環境変数
- Homebrew初期化（macOS）

**配置すべきでない内容**:
- 補完初期化（compinit）→ インタラクティブシェルでのみ必要
- エイリアス・関数 → インタラクティブシェルでのみ必要
- 出力を生成するコマンド

### `.zshrc` - インタラクティブシェル設定

**読み込みタイミング**: インタラクティブシェル起動時のみ

**処理順序**:
1. `typeset -U` - 重複パス防止
2. `auto_update.sh &!` - バックグラウンドで自動更新チェック
3. `compinit` - 補完システム初期化
4. `sheldon source` - プラグイン読み込み
5. `starship init zsh` - プロンプト初期化
6. `.zsh/*.zsh` - モジュール読み込み
6. PATH追加 - 各種ツールのパス設定

### `.zsh/opt.zsh` - シェルオプション

履歴関連の設定を集約：

| 設定 | 説明 |
|------|------|
| `HISTFILE` | 履歴ファイルのパス |
| `HISTSIZE` | メモリ上の履歴サイズ |
| `SAVEHIST` | ファイルに保存する履歴サイズ |
| `share_history` | ターミナル間で履歴共有 |
| `hist_ignore_dups` | 連続する重複を無視 |
| `hist_ignore_all_dups` | 全重複を削除 |
| `inc_append_history` | コマンド実行ごとに即座に保存 |

### `.zsh/keybinds.zsh` - キーバインド

| キー | 機能 |
|------|------|
| `Ctrl+R` | peco履歴検索 |
| `Ctrl+S` | pecoディレクトリ移動 |
| `Ctrl+^` | 親ディレクトリへ移動 |
| `Enter` | 空行でls + git status表示 |

**chpwd関数**: `cd`後に自動で`ls`を実行

### `.zsh/aliases.zsh` - エイリアス・関数

カテゴリ別に整理：
- Linux基本コマンド
- エディタ（emacs, code）
- SSH/tmux
- Git
- Docker
- 各種開発ツール

### `sheldon/plugins.toml` - プラグイン管理

**採用プラグイン**（最小限に抑制）:

| プラグイン | 用途 | 読み込み方式 |
|------------|------|--------------|
| zsh-defer | 遅延読み込み基盤 | 即時 |
| zsh-syntax-highlighting | コマンド構文ハイライト | 遅延 |
| zsh-completions | 追加補完定義 | 即時 |
| ohmyzsh-lib | 補完・ディレクトリ機能 | 即時 |

---

## 読み込み順序図

```
┌─────────────────────────────────────────────────────────┐
│ シェル起動                                              │
└─────────────────────────────────────────────────────────┘
                          │
                          ▼
┌─────────────────────────────────────────────────────────┐
│ .zshenv（全セッション）                                 │
│  • ロケール設定                                         │
│  • エディタ設定                                         │
│  • Homebrew初期化                                       │
└─────────────────────────────────────────────────────────┘
                          │
            ┌─────────────┴─────────────┐
            │                           │
     インタラクティブ              スクリプト実行
            │                           │
            ▼                           ▼
┌───────────────────────┐       ┌───────────────────┐
│ .zshrc                │       │ （終了）          │
│  • typeset -U         │       └───────────────────┘
│  • auto_update.sh &!  │
│  • compinit           │
│  • sheldon source     │
│  • starship init zsh  │
│  • .zsh/*.zsh 読み込み│
│  • PATH追加           │
└───────────────────────┘
            │
            ▼
┌───────────────────────────────────────────────────────┐
│ .zsh/ モジュール                                      │
│  ├── aliases.zsh   # エイリアス・関数                 │
│  ├── keybinds.zsh  # キーバインド・peco               │
│  └── opt.zsh       # 履歴オプション                   │
└───────────────────────────────────────────────────────┘
```

---

## 設計判断の根拠

### なぜSheldonか

| 観点 | Oh-My-Zsh | Sheldon |
|------|-----------|---------|
| 起動速度 | 遅い（全プラグイン読み込み） | 高速（必要なものだけ） |
| 設定形式 | シェルスクリプト | TOML（宣言的） |
| 遅延読み込み | プラグイン依存 | zsh-deferと統合可能 |
| 依存関係 | zsh | なし（Rustバイナリ） |

### なぜcompinit を .zshrc に配置するか

- `compinit`は補完システムの初期化で数百msかかる
- スクリプト実行時には補完不要
- `.zshenv`に置くと全シェル起動で実行され無駄

### なぜ auto_update.sh をバックグラウンド実行するか

- git fetch/pullはネットワーク待ちで数秒かかる可能性
- フォアグラウンドだとシェル起動がブロックされる
- `&!`でジョブ管理からも除外し、完全に非同期化

---

## 拡張ガイドライン

### 新しいエイリアスを追加する場合

`.zsh/aliases.zsh` の適切なカテゴリセクションに追加。

### 新しいプラグインを追加する場合

1. `sheldon/plugins.toml` に定義を追加
2. 重いプラグインは `apply = ["defer"]` を指定
3. `sheldon lock --update` でロックファイル更新

### 環境変数を追加する場合

- 全シェルで必要 → `.zshenv`
- インタラクティブのみ → `.zshrc` または `.zsh/*.zsh`

### OS固有の設定を追加する場合

`.zshenv` または `.zshrc` 内のプラットフォーム検出ブロックに追加：

```zsh
if [[ `uname` == 'Darwin' ]]; then
    # macOS固有の設定
elif [[ `uname` == 'Linux' ]]; then
    # Linux固有の設定
fi
```
